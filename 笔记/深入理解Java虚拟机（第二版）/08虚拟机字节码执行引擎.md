---
author: zjmantou
title: 08虚拟机字节码执行引擎
time: 2023-11-19 周日
tags:
  - Java
  - Java虚拟机
  - 笔记
---
# 运行时栈帧结构

栈帧（Stack Frame）是用于支持虚拟机进行方法调用和方法执行的数据结构，它是虚拟机运行时数据区中的虚拟机栈（Virtual Machine Stack）￼的栈元素。 

栈帧存储了方法的局部变量表、操作数栈、动态连接和方法返回地址等信息。 

每一个方法从调用开始至执行完成的过程，都对应着一个栈帧在虚拟机栈里面从入栈到出栈的过程。

![925B526B-64E2-4FAD-B7A3-F81694EE76FF.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202311192109130.png)


## 局部变量表（Local Variable Table）

一组变量值存储空间，用于存放方法参数和方法内部定义的局部变量。

局部变量表的容量以变量槽（Variable Slot，下称Slot）为最小单位。 

虚拟机通过索引定位的方式使用局部变量表，如果访问的是32位数据类型的变量，索引n就代表了使用第n个Slot，如果是64位数据类型的变量，则说明会同时使用n和n+1两个Slot。 

在方法执行时，虚拟机是使用局部变量表完成参数值到参数变量列表的传递过程的，如果执行的是实例方法（非static的方法），那局部变量表中第0位索引的Slot默认是用于传递方法所属对象实例的引用，在方法中可以通过关键字“**this**”来访问到这个隐含的参数。其余参数则按照参数表顺序排列，占用从1开始的局部变量Slot，参数表分配完毕后，再根据方法体内部定义的变量顺序和作用域分配其余的Slot。 

Slot可以重用，节省栈帧空间，但也有副作用，影响到系统的垃圾收集行为。 

## 操作数栈（Operand Stack）

一个后入先出的栈。 

举例：
整数加法的字节码指令iadd在运行的时候操作数栈中最接近栈顶的两个元素已经存入了两个int型的数值，当执行这个指令时，会将这两个int值出栈并相加，然后将相加的结果入栈。 

栈帧重叠部分：进行方法调用时共用一部分数据，无须进行饿哎的参数传递。 

![24E28C0B-67E0-4736-8192-E5DBA22BAADB.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202311192118303.png)

## 动态连接（Dynamic linking）

方法调用

## 返回地址（Return Address）

退出方法，把当前栈帧出栈。 

## 总结

虚拟机运行时执行字节码，是一个执行操作栈入栈、出栈，存取局部变量，方法调用，最后退出方法（栈帧出栈）的过程。 

# 方法调用

解析：
调用目标必须在程序代码写好、编译器进行编译时就必须确定下来。 

方法调用字节码指令：
- invokestatic：调用静态方法。
- invokespecial：调用实例构造器`<init>`方法、私有方法和父类方法。
- invokevirtual：调用所有的虚方法。
- invokeinterface：调用接口方法，会在运行时再确定一个实现此接口的对象。
- invokedynamic：先在运行时动态解析出调用点限定符所引用的方法，然后再执行该方法，在此之前的4条调用指令，分派逻辑是固化在Java虚拟机内部的，而invokedynamic指令的分派逻辑是由用户所设定的引导方法决定的。

invokestatic、invokespecial在解析中可以确定，包括：静态方法、私有方法、实例构造器、父类方法4类。叫非虚方法，除此之外都叫虚方法（final方法除外）。 为静态分派。

方法在运行时才能确定类型，为动态分派。

虚拟机的Override重写是因为虚拟机动态分派实现的。

![60C9C497-081B-460D-BFD6-402CD64C8638.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202311192129379.png)


# 字节码解释执行引擎

[[06Class类文件的结构#字节码指令]]

基于栈的指令集：
- 优点：可移植。
- 缺点：执行速度相对较慢一些。