---
author: zjmantou
title: 03.目标文件里有什么
time: 2024-08-14 周三
tags:
  - 笔记
  - cpp
---
编译器编译源代码后生成的文件叫目标文件。 

可执行文件： 
- windows的PE（Portable Executable）
- Linux下的ELF（Executable Linkable Format）

## ELF文件类型

![截屏2024-08-14 22.29.55.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202408142230707.png)


## 目标文件组成 

由文件头和Segment（section）组成：
1. 文件头：文件属性描述
2. .text段：编译后的机器指令
3. .data段：全局变量和局部静态变量
4. .bss段：未初始化的全局变量和局部静态变量

	**为什么不放在.data段？**
	因为未初始化的全局变量和局部静态变量默认值都为0，在.data段分配空间并且存放数据0是没有必要的。
	在程序运行时需要计算它们的大小总和，所以bss段只是为它们预留位置，并没有内容也不占空间 


### BSS段 

BSS（Block Started by Symbol）这个词最初是UA-SAP汇编器（United Aircraft Symbolic Assembly Program）中的一个伪指令，用于为符号预留一块内存空间。该汇编器由美国联合航空公司于20世纪50年代中期为IBM 704大型机所开发。

程序源代码被编译以后主要分成两种段：程序指令和程序数据。

分段的好处：
- 数据和指令分别被分区映射，防止程序指令被修改。
- 有利于提高程序的局部性
- 提高内存中的指令复用率。

**真正了不起的程序员对自己的程序的每一个字节都了如指掌** 

### 自定义段 

通过`__attribute__((section(“name”)))`属性就可以把相应的变量或函数放到以“name”作为段名的段中. 

## ELF结构 

![image.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202408142332963.png)

### 文件头 

![image.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202408142334201.png)

ELF的文件头中定义了ELF魔数、文件机器字节长度、数据存储方式、版本、运行平台、ABI版本、ELF重定位类型、硬件平台、硬件平台版本、入口地址、程序头入口和长度、段表的位置和长度及段的数量等。 


#### Elf32_Ehdr 

32位的ELF文件头 

```C
//usr/include/elf.h

typedef struct {
    unsigned char e_ident[16];
    Elf32_Half e_type;
    Elf32_Half e_machine;
    Elf32_Word e_version;
    Elf32_Addr e_entry;
    Elf32_Off  e_phoff;
    Elf32_Off  e_shoff;
    Elf32_Word e_flags;
    Elf32_Half e_ehsize;
    Elf32_Half e_phentsize;
    Elf32_Half e_phnum;
    Elf32_Half e_shentsize;
    Elf32_Half e_shnum;
    Elf32_Half e_shstrndx;
} Elf32_Ehdr;

```

e_type:
ET_REL：1，可重定位文件，一般为.o文件
ET_EXEC：2，可执行文件
ET_DYN：3，共享目标文件，一般为.so文件 

### 段表 

`readelf -S xxx.o` 



## binutils工具 

### objdump  

查看object内部的结构

-s : 将所有段的内容以16进制的方式打印出来
-d：将所有包含指令的段反汇编；

![截屏2024-08-14 23.06.05.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202408142311965.png)

### readelf 

查看ELF文件 

![image.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202408142334201.png)


