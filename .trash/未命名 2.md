**概述**

蓝牙Mesh网络支持多对多(m:m)设备通信，并针对创建大规模设备网络的需求进行了优化。它非常适合楼宇自动化、传感器网络、资产跟踪和其他需要数十、数百或数千台设备相互通信的物联网(IoT)解决方案。

与其他低功耗无线Mesh网络技术不同，蓝牙Mesh网络是一个完整的全栈解决方案，它定义了从物理无线电层到应用层的所有技术规范。除了有助于实现更简单的产品开发和更高级的产品互操作性之外，这种全栈解决方案还可以实现更快、更顺畅的技术迭代与演进。

蓝牙Mesh网络与其他无线Mesh网络技术的比较如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/bc054ad129694dc4825f91dc45537604.jpg)

CSA连接标准联盟(原Zigbee联盟)近期发布的Matter是基于互联网协议(IP)的物联网应用层技术标准，Matter本身并不是一种网络传输技术。各种有线和无线传输技术均可实现对Matter通信协议的支持，例如以太网、Wi-Fi、基于802.15.4的Thread等。低功耗蓝牙也可作为传输Matter的物理层和数据链路层，相关技术规范正在开发中。

**基本特点**

蓝牙Mesh网络采用一种称为“网络泛洪（flooding）”的方式来发布和中继消息。这意味着消息不会通过某一过程进行路由, 也不会沿着由一系列特定设备构成的特定路径来进行传输。相反，传输范围内的所有设备都会接收消息，负责中继的设备能将消息转发至其传输范围内的所有其他设备。

网络泛洪的优势在于无需特定设备专门扮演集中式路由器的角色。集中式路由器一旦发生故障，就可能会导致整个网络无法运行，从而影响网络通信的可靠性。

网络泛洪的方式也意味着消息一般能够通过多重路径到达其目的地，路径中一个或多个节点的故障并不会影响其他路径上的消息传递，这就构建了一个相当可靠的网络。

中继设备能够转发从其他设备接收到的消息。在转发消息时，它们能够与位于初始消息发布设备无线范围以外的设备进行通信。消息可多次被中继，每一次中继即为一“跳”，最多可进行127跳(每一条消息允许的跳数决定其存在时间-time to life)，足以在一片广阔的物理区域中进行消息传输。

蓝牙Mesh网络通信相较一般蓝牙微微网(Piconet)通信的最大差异是其绝大部份消息传递是基于无连接传输模式 (connectionless)，绝大多数节点间并不存在传统意义上的“连接”。

**技术架构**

蓝牙Mesh网络的技术架构如下图所示。

![](file:///Users/mantou/.config/joplin-desktop/resources/ee58bc625ae04d2b9fd4683b01684e5d.jpg)

其中最底层的低功耗蓝牙核心规范在《Bluetooth® Core Specification》中定义；中间蓝色各层均在《Mesh Profile》蓝牙规范中定义；最上面的模型层在《Mesh Model》蓝牙规范中定义。

各层的功能说明如下:

**模型（models）**：用于实现网络节点设备的基本功能的模型以及相关的状态、消息和控制行为。定义了通用模式(例如开关)、传感器模式、照明控制模式及时间与场景模式。

**基础模型（foundation models）**：基础模型层负责实现与Mesh网络配置和管理相关的模型。

**接入层（access layer）**：负责应用数据的格式、定义并控制上层传输层中执行的加密和解密过程，并在将数据转发到协议栈之前，验证接收到的数据是否适用于正确的网络和应用。

**上层传输层（upper transport layer）**：负责对接入层进出的应用数据进行加密、解密和认证。它还负责称为“传输控制消息”（transport control messages）这一特殊的消息，包括与“friendship”相关的心跳和消息。

**底层传输层（lower transport layer）**：在需要之时，底层传输层能够处理PDU的分段和重组。

**网络层（network layer）**：网络层定义了各种消息地址类型和网络消息格式。中继和代理行为通过网络层实施。

**承载层（bearer layer）**：承载层定义了如何使用底层低功耗堆栈传输PDU。目前定义了两个承载层：广播承载层（Advertising Bearer）和GATT承载层。

**低功耗蓝牙核心规范（Bluetooth Low Energy Core Specification）**: 为Mesh网络消息的无线传输提供标准解决方案。广播承载层基于低功耗蓝牙链路层的广播(Advertising)机制，GATT承载层则基于低功耗蓝牙的ACL连接机制。

**拓扑结构**

蓝牙Mesh网络的拓扑结构如下图所示。

![](file:///Users/mantou/.config/joplin-desktop/resources/e7ed54abb2fe4b58893f31d5faff4d52.jpg)

不同颜色节点说明如下:

**蓝色节点**为普通终端节点，不能中继网络消息，但可以直接从网络接收消息也可直接向网络发送消息。

**黄色节点**为低功耗节点，这些节点通常由电池供电，其仅与关联的朋友节点通信并通过朋友节点间接收发网络消息。

**红色节点**为中继节点，起到消息中继的作用，是实现网络消息远距离传输的关键。

**紫色节点**为朋友节点，在低功耗节点和网络间传递消息。

图中S节点与T节点间的通信使用基于低功耗蓝牙ACL连接的GATT承载；其余节点间的通信均使用基于低功耗蓝牙广播的广播承载。

**通信机制**

蓝牙Mesh网络是以消息为中心的通信网络。

蓝牙Mesh网络使用发布/订阅 (Publish/Subscribe)消息系统。

设备可以将消息发送至特定地址(单播)或地址群(群组)，这些地址的名称和含义与用户能够理解的高级概念相对应，如“厨房灯”(Kitchen Lights)。这被称为“发布”(Publish)。

设备经配置后，可接收由其他设备发送到特定地址的消息。这被称为“订阅”(Subscribe)。

当设备向特定地址发布消息时，订阅该地址的所有其他设备将收到该地址的副本，对其进行处理，并以某种方式作出回应。

由于节点之间的相互控制关系往往不是一对一的简单模式，引入发布和订阅的概念后将控制关系本身与物理节点独立出来，从而各节点可以通过特定的配置过程来实现复杂的控制关系并可以减少节点维护的工作量。

**地址类型**

蓝牙Mesh网络定义了四种地址类型，其中的三类用于消息的传送：单播（unicast）地址、虚拟（virtual）地址和群组（group）地址。第四种被称为未分配（unassigned）地址。

**未分配地址（Unassigned Address）0000000000000000**：未经配置的节点元素或未被指定地址的节点元素拥有的就是未分配地址。鉴于这些节点元素没有唯一的地址，它们不会用于消息传送。

**单播地址（Unicast Address）0xxxxxxxxxxxxxxx** : 在“启动配置”（provisioning）期间，启动配置设备（provisioner）会在网络节点的生命周期内为节点中的每个节点元素(一个节点Node可以有多个节点元素Element, 例如一个多孔插座作为一个节点，插座上的每一个插孔都是一个独立的节点元素)分配一个单播地址。单播地址可能出现在消息的源地址字段或目的地址字段中。发送到单播地址的消息只能由一个节点元素进行处理。

**虚拟地址（Virtual Address）10xxxxxxxxxxxxxx** : 虚拟地址是与特定的UUID标签相关联的一组节点元素；这些地址可能会被用于消息发布或订阅。UUID标签是与多个来自一个或多个节点的元素相关联的128位值。

**群组地址（Group Address）11xxxxxxxxxxxxxx** : 群组地址是蓝牙Mesh网络中的另一种多播地址（multicast address），它通常代表一个或多个节点中的多个节点元素。 Mesh规范中定义的四种固定群组地址如下:

- **1111111111111100,** 所有代理节点
- **1111111111111101**, 所有朋友节点
- **1111111111111110**, 所有中继节点
- **1111111111111111**, 所有节点

**网络极限**

根据《Mesh Profile》蓝牙技术规范蓝牙Mesh网络的能力极限如下:

每个Mesh网络中的元素数量(一点节点可以有一个或多个元素): 2^15

每个Mesh网络中的群组地址数量: 2^14

每个Mesh网络中的虚拟地址数量: 2^46

每个Mesh网络中的应用数量: 2^12

每个Mesh网络中的子网数量: 2^12

每个Mesh网络每个元素可发送的消息数量: 2^56

Mesh网络数量: 2^128

**蓝牙Mesh网络的消息发布与订阅通信机制剖析**

与其他无线Mesh网络相比蓝牙Mesh网络有以下两个特点和优势:

- 蓝牙Mesh网络采用分布式控制架构，其他无线Mesh网络采用集中式控制架构。例如在基于蓝牙Mesh网络的照明控制系统中开关和传感器不会与控制灯的中央控制器通信，而是直接与灯通信。这种分布式控制架构使系统能够实现更大的规模、更高的可靠性和更低的成本。
- 绝大多数其他无线Mesh网络均使用单个设备寻址的通信方式，蓝牙Mesh网络除了支持单个设备寻址外还支持基于群组地址的多播寻址方式。蓝牙Mesh网络的多播寻址方式采用独特的发布/订阅(pub/sub)通信机制。在发布/订阅通信机制中，设备(如电灯开关)将它们的消息发布到一个群组地址(如会议室)，应接收此消息的所有设备(如会议室中的灯)都订阅了发布到此群组地址上的消息。发布/订阅通信机制可显著降低网络上的消息传递流量，从而实现更大网络规模和更佳通信性能。

蓝牙Mesh网络与传统基于路由的消息传递机制的比较如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/d5ab32ad3c2f4cb0b23eb31b2275245e.jpg)

以下通过对多个设备与多个设备间控制关系示例的一步步剖析来说明蓝牙Mesh网络采用消息发布与订阅机制的原理和优势。**其中的核心理念是将控制关系本身从物理设备上抽象出来，并形成一个新的概念-“群组”, 并通过向”群组”赋予人可以理解的语言从而实现简单友善的人机控制界面。**

假设为了实现下图中的一组开关与一组灯间的控制关系，按照传统的思维方式有两种配置通信模式的方式，一种是在开关侧记忆其控制的灯的ID信息；另一种是在灯侧记忆控制其的开关的ID信息。

![](file:///Users/mantou/.config/joplin-desktop/resources/924927b576944fed9670e18ee1a7a033.jpg)

当采用在开关侧配置通信模式时，需要在每一个开关中记忆其控制的灯的ID信息。如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/2b7805ad6fa148b4801ebe3501edfc0c.jpg)

采用在开关侧配置通信模式后，一盏灯更换后需要在所有控制此盏灯的开关上重新记忆其控制的灯的ID信息, 维护工作量大。如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/5ab2a3bd5d6a4336941bdd137e0d097c.jpg)

当采用在灯侧配置通信模式时，需要在每一盏灯中记忆控制其的开关的ID信息。如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/db60836c524c45959672d246a18be84c.jpg)

采用在灯侧配置通信模式后，一个开关更换后需要在其控制的所有盏灯上重新记忆此开关的ID信息, 维护工作量大。如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/26b1db4ef12f4452add40fff3198779f.jpg)

将开关和灯的控制关系虚拟化，提取出新的概念”群组”。 如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/50e15575589943dab8c048051a95bea4.jpg)

“群组”独立于开关和灯并表示一个独特的控制关系本身。如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/a88eb97f02af48e394964e5878aa78f0.jpg)

每一个开关发布控制消息到”群组”; 每一盏灯订阅不同的”群组”消息。如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/ae20fea8034949dd906a36d3acf1a19c.jpg)

每一个”群组”可命名为用户可理解的有特定含义的名称。如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/1b43567c2f8d4b1da44e3ae994ad9fa9.jpg)

任何开关更换后只需要将其配置为**向特定的群组发布消息**即可。如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/c6e3b76989f44e4d95c9568a1518cfd3.jpg)

任何灯更换后只需要将其配置为**订阅特定的群组消息**即可。如下图所示:

![](file:///Users/mantou/.config/joplin-desktop/resources/447963e679584042addaf3028a48487f.jpg)

扩展到任何通信设备，开关和灯均为网络节点，每一个群组有唯一的群组地址(Group Address)并有特定的用户可理解的含义。**控制设备向具有特定含义的群组地址发布控制消息；受控设备从其订阅的具有特定含义的群组地址接收消息，这是所有蓝牙Mesh网络的通信模式。**如下图所示:、

![](file:///Users/mantou/.config/joplin-desktop/resources/7c956aa71a2442eabcb3b254f9ff791c.jpg)