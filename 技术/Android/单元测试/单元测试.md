---
author: zjmantou
title: 单元测试
time: 2024-08-28 周三
tags:
  - Android
  - 单元测试
---
# JUnit4规则 

## ActivityScenarioRule 

提供单个Activity的功能测试。 

```kotlin
@RunWith(AndroidJUnit4::class.java)
@LargeTest
class MyClassTest {
  @get:Rule
  val activityRule = ActivityScenarioRule(MyClass::class.java)

  @Test fun myClassMethod_ReturnsTrue() {
    activityRule.scenario.onActivity { … } // Optionally, access the activity.
   }
}
```


	如果需要测试fragment，可以使用FragmentScenario类（AndroidX fragment—testing库） 

## ServiceTestRule 

测试Service。 

	不支持IntentService。 

```kotlin
@RunWith(AndroidJUnit4::class.java)
@MediumTest
class MyServiceTest {
  @get:Rule
  val serviceRule = ServiceTestRule()

  @Test fun testWithStartedService() {
    serviceRule.startService(
      Intent(ApplicationProvider.getApplicationContextC<ontext(>),
      MyService::class.java))
    // Add your test code here.
  }

  @Test fun testWithBoundService() {
    val binder = serviceRule.bindService(
      Intent(ApplicationProvider.getApplicationContext(),
      MyService::class.java))
    val service = (binder as MyService.LocalBinder).service
    assertThat(service.doSomethingToReturnTrue()).isTrue()
  }
}
```

# AndroidJUnitRunner 

一个JUnit测试运行程序，可以在设备上运行插桩JUnit测试，包括[Espresso](https://developer.android.com/training/testing/espresso?hl=zh-cn)、[UI Automator](https://developer.android.com/training/testing/ui-automator?hl=zh-cn) 和 [Compose](https://developer.android.com/jetpack/compose/testing?hl=zh-cn) 的应用 测试框架. 

	本地测试不需要 `AndroidJUnitRunne` 

负责将测试软件包和被测应用加载到 运行测试并报告测试结果. 

## 编写JUnit测试 

验证`ChangeTextBehavior` 中的 `changeText` 操作 类正常工作： 

```kotlin
package com.example.kotlinproject  
  
import androidx.test.espresso.Espresso  
import androidx.test.espresso.action.ViewActions  
import androidx.test.espresso.assertion.ViewAssertions  
import androidx.test.espresso.matcher.ViewMatchers  
import androidx.test.ext.junit.rules.ActivityScenarioRule  
import androidx.test.ext.junit.runners.AndroidJUnit4  
import androidx.test.filters.LargeTest  
import androidx.test.rule.ActivityTestRule  
import org.junit.Rule  
import org.junit.Test  
import org.junit.runner.RunWith  
  
/**  
 * @author HuangNing  
 * @desc  
 */  
@RunWith(AndroidJUnit4::class)  
@LargeTest  
class ChangeTextBehaviorTest {  
    val stringToBeTyped = "Espresso"  
  
    @get:Rule  
    val activityRule = ActivityTestRule(MainActivity::class.java)  
  
    @Test  
    fun changeText_sameActivity() {  
        Espresso.onView(ViewMatchers.withId(R.id.main))  
            .perform(ViewActions.typeText(stringToBeTyped), ViewActions.closeSoftKeyboard())  
        Espresso.onView(ViewMatchers.withId(R.id.main)).perform(ViewActions.click())  
  
        Espresso.onView(ViewMatchers.withId(R.id.main))  
            .check(ViewAssertions.matches(ViewMatchers.withText(stringToBeTyped)))  
    }  
  
}
```

示例源码：[test-samples/CalculatorInstrumentationTest](https://github.com/android/testing-samples/blob/main/runner/AndroidJunitRunnerSample/app/src/androidTest/java/com/example/android/testing/androidjunitrunnersample/CalculatorInstrumentationTest.java) 

## 访问应用的上下文 

ApplicationProvider.getApplicationContext()

InstrumentationRegistry 

## 过滤测试 

- **`@RequiresDevice`** : 指定在真机上测试；
- **`@SdkSuppress`** ： 指定SDK，比如最低sdk——（@SDKSuppress(minSdkVersion=23）
- **`@SmallTest`、`@MediumTest` 和 `@LargeTest`**： 测试时长分类

```shell
-Pandroid.testInstrumentationRunnerArguments.size=small
```

## 将测试分片 

单个测试拆分多个 

- -e numShards：要创建单独分片的数量； 
- -e shardIndex： 指定要运行哪个分片； 

```
adb shell am instrument -w -e numShards 10 -e shardIndex 2
```

## 使用 Android Test Orchestrator

- 最小共享状态：每个测试都在自己的Instrumentation中运行实例；
- 崩溃被隔离：一个测试崩溃，不会影响其他； 

### 从Gradle启用 

#### 第一步 

```groovy
android {
 defaultConfig {
  ...
  testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"

  // The following argument makes the Android Test Orchestrator run its
  // "pm clear" command after each test invocation. This command ensures
  // that the app's state is completely cleared between tests.
  testInstrumentationRunnerArguments clearPackageData: 'true'
 }

 testOptions {
  execution 'ANDROIDX_TEST_ORCHESTRATOR'
 }
}

dependencies {
 androidTestImplementation 'androidx.test:runner:1.1.0'
 androidTestUtil 'androidx.test:orchestrator:1.1.0'
}
```

#### 第二步 

```shell
./gradlew connectedCheck
```

### 从Android Studio启用 

如需在 Android Studio 中启用 Android Test Orchestrator，请添加如下所示的语句 [Enable from Gradle](https://developer.android.com/training/testing/instrumented-tests/androidx-test-libraries/runner?hl=zh-cn#enable-gradle) 添加到应用的 `build.gradle` 文件。

### 从命令行启用 

在终端运行以下命令 

```bash
DEVICE_API_LEVEL=$(adb shell getprop ro.build.version.sdk)

FORCE_QUERYABLE_OPTION=""
if [[ $DEVICE_API_LEVEL -ge 30 ]]; then
   FORCE_QUERYABLE_OPTION="--force-queryable"
fi

# uninstall old versions
adb uninstall androidx.test.services
adb uninstall androidx.test.orchestrator

# Install the test orchestrator.
adb install $FORCE_QUERYABLE_OPTION -r path/to/m2repository/androidx/test/orchestrator/1.4.2/orchestrator-1.4.2.apk

# Install test services.
adb install $FORCE_QUERYABLE_OPTION -r path/to/m2repository/androidx/test/services/test-services/1.4.2/test-services-1.4.2.apk

# Replace "com.example.test" with the name of the package containing your tests.
# Add "-e clearPackageData true" to clear your app's data in between runs.
adb shell 'CLASSPATH=$(pm path androidx.test.services) app_process / \
 androidx.test.services.shellexecutor.ShellMain am instrument -w -e \
 targetInstrumentation com.example.test/androidx.test.runner.AndroidJUnitRunner \
 androidx.test.orchestrator/.AndroidTestOrchestrator'
```

