---
author: zjmantou
title: 类加载机制
time: 2023-11-19 周日
tags:
  - Java
  - Android
  - 笔记
---


# 双亲委派机制

加载一个类时，会向指定父类ClassLoader询问是否被加载过，如果没有加载过，继续向上级父类询问是否被加载过，如果被加载过，则返回类的对象，如果类没有被加载过，则开始委派子类进行加载该类对象。

[[07虚拟机类加载机制#类加载器ClassLoader]]

android中有几个比较重要的类加载器

- BootClassLoader根类加载器，单例模式由JAVA实现（与java中的BootStrapClassLoader不同），同样是android中所有类加载器的祖先，负责加载系统核心类。
- BaseDexClassLoader是PathClassLoader、DexClassLoader、InMemoryDexClassLoader的父类。
- PathClassLoader是用来加载Android系统类和app应用类的
- DexClassLoader可以加载任意目录下的dex/jar/apk/zip文件
- InMemoryDexClassLoader是是API26（android 8.0）新增的类加载器，继承自BaseDexClassLoader。  
    下图为各个类加载器的继承关系图（并不是委派关系图）
![image.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202311192053338.png)


# 主要作用
1. **防止重复加载同一个类**。当某个类加载器需要加载某个.class文件时，它首先把这个任务委托给它的上级类加载器，递归这个操作，如果上级的类加载器没有加载，那么自己才会去加载这个类。通过这种方式，如果一个类已经被加载过，那么再次遇到需要加载同类的情况时，就可以避免重复加载。
2. **保证核心类不能被篡改**。双亲委派机制要求类加载器在加载核心类时，必须向上级类加载器进行委托。这样，核心类只能由顶层的启动类加载器加载，保证了核心类的稳定性和安全性，不会被随意篡改。
3. **确保类的版本的一致性**。由于双亲委派机制的存在，同一个类无论由哪个类加载器加载，都将会是同一个Class对象。这就确保了类的版本的一致性，不会因为不同的类加载器而加载到不同版本的类。

# PathDexList查找Class机制

通过PathDexList的findClass方法，遍历dexElements获取dexFile，调用 DexFile 的 loadClassBinaryName 加载对应的类。

# 类查找的顺序机制

dexElements数组永远都是从0开始索引，找到后就返回；

# 热修复原理

将修复好的Dex文件插入在前面就可以屏蔽后面出现问题的类；

热修复只是在前面插入一个修复好的 Dex 文件 , 不会删除出现问题的 Dex 文件 

如果第 1  个 Dex 文件出现问题 , 只能发布新版本

