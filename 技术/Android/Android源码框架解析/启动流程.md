---
author: zjmantou
title: 启动流程
time: 2023-10-24 周二
tags:
  - Android
  - 源码
---
![系统启动.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202402111503170.png)


# 设备启动流程

## 启动电源以及系统启动

当电源按下时引导芯片代码从预定义的地方（固化在ROM）开始执行。加载引导程序BootLoader到RAM，然后执行  

## 引导程序BootLoader

引导程序BOotLoader是在Android操作系统开始运行前的一个小程序，它的主要作用是把系统OS拉起来并运行  

## Linux内核启动

当内核启动时，设置缓存、被保护存储器、计划列表、加载驱动。当内核完成系统设置时，它首先在系统文件中寻找init.rc文件，并启动init进程  

## init进程启动

初始化和启动属性服务，并启动Zygote进程  

## Zygote进程启动

创建Java虚拟机并为Java虚拟机注册JNI方法，创建服务器端Socket，启动SystemServer进程  

## SystemServer进程启动

启动Binder线程池和SystemServiceManager，并且启动各种系统服务  

## Launcher启动

```mermaid
sequenceDiagram

participant ams as ActivityManagerService

participant ass as ActivityStackSupervisor

  

note right of ams : systemReady

ams ->> ass : resumeFocusedStackTopActivityLocked

note left of ass : resumeHomeStackTask

ass ->> ams : rtHomeActivityLocked

alt Intent.CATEGORY_HOME 是否启动

note left of ActivityStarter : 启动launcher

ams ->> ActivityStarter : startHomeActivityLocked

ActivityStarter ->> ass : moveHomeStackTaskToTop

note right of ass : 存入HomeStack中

ActivityStarter ->> ActivityStarter : startActivityLocked

note left of ActivityStarter : 启动Launcher

end
```


## 启动流程图

![设备启动流程](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202310222145183.png)

![image.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202310241612375.png)


# Launcher启动流程

1.  Launcher进程请求AMS；
2. AMS发送创建应用进程请求；
3. Zygote进程接受请求并孵化应用进程；
4. 应用进程启动ActivityThread；
5. 应用进程绑定到AMS；
6. AMS发送启动Activity的请求；
7. ActivityThread的Handler处理启动Activity的请求；

## 启动流程图

### Launcher进程请求AMS

![image.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202310241618268.png)

### AMS发送创建应用进程请求

```mermaid
sequenceDiagram

actor caller

participant ams as ActivityManagerService

participant Process

participant ZygoteProcess

participant ZygoteState

  

note left of ams : startProcessLocked

caller ->>+ ams : startProcessLocked

  

ams ->>+ Process : start

  

Process ->> ZygoteProcess : start

ZygoteProcess ->> ZygoteProcess : startViaZygote

ZygoteProcess ->> ZygoteProcess : zygoteSendArgsAndGetResult

note left of ZygoteProcess : 将传入的应用进程的启动参数argsForZygote写入ZygoteState

ZygoteProcess ->> ZygoteProcess : openZygoteSocketIfNeeded

ZygoteProcess ->> ZygoteState : connect

note right of ZygoteState : 与Ztgote进程的socket连接

  

Process -->>- ams : ProcessStartResult

  

ams -->>- caller : ProcessRecord
```

![image.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202310241619856.png)

### Zygote进程接受请求并孵化应用进程

![image.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202310241619180.png)

### 应用进程启动ActivityThread

![image.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202310241619759.png)

## 应用程序Binder线程池创建过程

```mermaid
sequenceDiagram

participant ZygoteInit

box Purple JNI

participant AndroidRuntime

end

box Gray native

participant AppRumtime

participant ProcessState

participant IPCThreadState

end

ZygoteInit ->> AndroidRuntime : nativeZygoteInit

note left of AppRumtime : app_main.cpp

AndroidRuntime ->> AppRumtime : onZygoteInit

AppRumtime ->> ProcessState : startThreadPool

note right of ProcessState : PoolThread

ProcessState ->> IPCThreadState : joinThreadPool
```

# 应用内启动流程
1. App进程通过AMS向system_server进程发送请求；
2. system_server进行准备工作处理（解析activity、启动参数处理）再通过Binder通知app进程；
3. app进程收到消息后创建activity，进入生命周期。
4. 

## 启动流程图

```mermaid
sequenceDiagram

actor user

participant Launcher

participant Activity

participant Instrunmentation

participant IActivityManager

box Systemserver进程

participant ams as AMS

participant ActivityStarter

participant ass as ActivityStackSupervisor

participant ast as ActivityStack

end

box 应用程序进程

participant ApplicationThread

participant ActivityThread

participant H

participant Instrunmentation2

participant Activity2

end

user ->> Launcher : startActivitySafely

Launcher ->> Activity : startActivity

Activity ->> Activity : startActivityForResult

Activity ->> Instrunmentation : execStartActivity

Instrunmentation ->> IActivityManager : startActivity

IActivityManager ->> ams : startActivity

  

ams ->> ams : startActivityAsUser

ams ->> ActivityStarter : startActivityMayWait

ActivityStarter ->> ActivityStarter : startActivityLocked

ActivityStarter ->> ActivityStarter : startActivity

ActivityStarter ->> ActivityStarter : startActivityUnchecked

ActivityStarter ->> ass : resumeFocusedStackTopActivityLocked

ass ->> ast : resumeTopActivityUncheckedLocked

ast ->> ast : resumeTopActivityinnerLocked

ast ->> ass : startSpecificActivityLocked

ass ->> ass : realStartActivityLocked

ass ->> ApplicationThread : scheduleLaunchActivity

ApplicationThread ->> ActivityThread : sendMessage

ActivityThread ->> H : handleMessage

H ->>+ ActivityThread : handleLaunchActivity

ActivityThread -> ActivityThread : performLaunchActivity

ActivityThread ->>- Instrunmentation2 : callActivityOnCreate

Instrunmentation2 ->> Activity2 : performCreate

Activity2 ->> Activity2 : onCreate
```

![image.png](https://zjmantou-drawingbed.oss-cn-hangzhou.aliyuncs.com/picture/202310241702994.png)


# 参考资料
[Activity的启动流程简述](https://blog.csdn.net/cpcpcp123/article/details/122055099)
[Activity的启动流程](https://blog.csdn.net/NakajimaFN/article/details/125916330)