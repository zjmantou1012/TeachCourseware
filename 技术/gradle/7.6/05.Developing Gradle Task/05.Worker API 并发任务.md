---
author: zjmantou
title: 05.Worker API 并发任务
time: 2024-08-01 周四
tags:
  - 技术
  - Gradle
---
# [使用 Worker API 开发并行任务](https://docs.gradle.org/7.6/userguide/worker_api.html) 

# 创建自定义任务 

创建一个自定义任务来生成一组可配置文件的 MD5 哈希值。 

自定义任务类将使用[Apache Commons Codec](https://commons.apache.org/proper/commons-codec/)生成 MD5 哈希值。 

```groovy
//buildSrc/build.gradle
repositories {
    mavenCentral()
}

dependencies {
    implementation 'commons-io:commons-io:2.5'
    implementation 'commons-codec:commons-codec:1.9' 
}
```

```Java
//buildSrc/src/main/java/CreateMD5.java

import org.apache.commons.codec.digest.DigestUtils;
import org.apache.commons.io.FileUtils;
import org.gradle.api.file.DirectoryProperty;
import org.gradle.api.file.RegularFile;
import org.gradle.api.provider.Provider;
import org.gradle.api.tasks.OutputDirectory;
import org.gradle.api.tasks.SourceTask;
import org.gradle.api.tasks.TaskAction;
import org.gradle.workers.WorkerExecutor;

import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;

abstract public class CreateMD5 extends SourceTask { //1

    @OutputDirectory
    abstract public DirectoryProperty getDestinationDirectory(); //2

    @TaskAction
    public void createHashes() {
        for (File sourceFile : getSource().getFiles()) { //3
            try {
                InputStream stream = new FileInputStream(sourceFile);
                System.out.println("Generating MD5 for " + sourceFile.getName() + "...");
                // Artificially make this task slower.
                Thread.sleep(3000); //4
                Provider<RegularFile> md5File = getDestinationDirectory().file(sourceFile.getName() + ".md5");  //5
                FileUtils.writeStringToFile(md5File.get().getAsFile(), DigestUtils.md5Hex(stream), (String) null);
            } catch (Exception e) {
                throw new RuntimeException(e);
            }
        }
    }
}

```

1. [SourceTask](https://docs.gradle.org/7.6/javadoc/org/gradle/api/tasks/SourceTask.html)是对一组源文件进行操作的任务的便捷类型。
2. 任务的输出将进入配置的目录。
3. 该任务迭代所有定义为“源文件”的文件并创建每个文件的 MD5 哈希值。
4. 模拟大文件耗时。
5. 每个文件的 MD5 哈希值将写入输出目录中，并写入具有“md5”扩展名的同名文件中。

创建一个build.gradle(.kts)来注册新的CreateMD5任务。

```groovy
plugins { id 'base' } //1

tasks.register("md5", CreateMD5) {
    destinationDirectory = project.layout.buildDirectory.dir("md5") //2
    source(project.layout.projectDirectory.file('src')) //3
}
```

1. 应用base插件，以便您可以使用`clean`任务来删除输出。
2. MD5 哈希文件将写入`build/md5` 。
3. 此任务将为`src`目录中的每个文件生成 MD5 哈希文件。

在src目录下创建3个文件：

```java
//src/einstein.txt src/爱因斯坦.txt
Intellectual growth should commence at birth and cease only at death.
//src/feynman.txt
I was born not knowing and have had only a little time to change that here and there.
//src/oppenheimer.txt src/奥本海默.txt
No
```

执行任务
```shell
$ gradle md5

> Task :md5
Generating MD5 for einstein.txt...
Generating MD5 for feynman.txt...
Generating MD5 for oppenheimer.txt...
BUILD SUCCESSFUL in 0s
3 actionable tasks: 3 executed
```

在build/md5目录中，您现在应该看到带有md5扩展名的相应文件，其中包含src目录中文件的 MD5 哈希值

这里是串行的，也就是说需要至少9秒. 

# 转换为Woker 

```java
//buildSrc/src/main/java/MD5WorkParameters.java 

import org.gradle.api.file.RegularFileProperty;
import org.gradle.workers.WorkParameters;

public interface MD5WorkParameters extends WorkParameters {
    RegularFileProperty getSourceFile(); 
    RegularFileProperty getMD5File();
}
```

```Java
//buildSrc/src/main/java/GenerateMD5.java

import org.apache.commons.codec.digest.DigestUtils;
import org.apache.commons.io.FileUtils;
import org.gradle.workers.WorkAction;

import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;

public abstract class GenerateMD5 implements WorkAction<MD5WorkParameters> { 
    @Override
    public void execute() {
        try {
            File sourceFile = getParameters().getSourceFile().getAsFile().get();
            File md5File = getParameters().getMD5File().getAsFile().get();
            InputStream stream = new FileInputStream(sourceFile);
            System.out.println("Generating MD5 for " + sourceFile.getName() + "...");
            // Artificially make this task slower.
            Thread.sleep(3000);
            FileUtils.writeStringToFile(md5File, DigestUtils.md5Hex(stream), (String) null);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
}
```

改造CreateMD5，使用WorkerExecutor： 

```Java
//buildSrc/src/main/java/CreateMD5.java

import org.gradle.api.Action;
import org.gradle.api.file.RegularFile;
import org.gradle.api.provider.Provider;
import org.gradle.api.tasks.*;
import org.gradle.workers.*;
import org.gradle.api.file.DirectoryProperty;

import javax.inject.Inject;
import java.io.File;

abstract public class CreateMD5 extends SourceTask {

    @OutputDirectory
    abstract public DirectoryProperty getDestinationDirectory();

    @Inject
    abstract public WorkerExecutor getWorkerExecutor(); 

    @TaskAction
    public void createHashes() {
        WorkQueue workQueue = getWorkerExecutor().noIsolation(); 

        for (File sourceFile : getSource().getFiles()) {
            Provider<RegularFile> md5File = getDestinationDirectory().file(sourceFile.getName() + ".md5");
            workQueue.submit(GenerateMD5.class, parameters -> { 
                parameters.getSourceFile().set(sourceFile);
                parameters.getMD5File().set(md5File);
            });
        }
    }
}

```

```shell
$ gradle clean md5

> Task :md5
Generating MD5 for einstein.txt...
Generating MD5 for feynman.txt...
Generating MD5 for oppenheimer.txt...

BUILD SUCCESSFUL in 0s
3 actionable tasks: 3 executed
```

由于工作单元是并行执行的，MD5 哈希文件可能会以不同的顺序生成. 

## [改变隔离模式](https://docs.gradle.org/7.6/userguide/worker_api.html#changing_the_isolation_mode) 

- noIsolation():防止Worker单元更改状态
- classLoaderIsolation()：在具有隔离类加载器的线程中运行；
- processIsolation()：工作在单独的“worker daemon”中。（第一次构建期间会创建进程，可能比较慢，后续构建都可以立即使用）

```Java
WorkQueue workQueue = getWorkerExecutor().noIsolation();  
for (File sourceFile : getSource().getFiles()) {  
    Provider<RegularFile> md5File = getDestinationDirectory().file(sourceFile.getName() + ".md5");  
    workQueue.submit(GenerateMD5.class, parameters -> {  
        parameters.getSourceFile().set(sourceFile);  
        parameters.getMd5File().set(md5File);  
    });}
```

```Java
WorkQueue workQueue = getWorkerExecutor().classLoaderIsolation(workerSpec -> {  
    workerSpec.getClasspath().from(getCodecClasspath());  
});
```

```java
WorkQueue workQueue = getWorkerExecutor().processIsolation(workerSpec -> {  
   workerSpec.getClasspath().from(getCodecClasspath());  
   workerSpec.forkOptions(forkOptions -> {  
       forkOptions.setMaxHeapSize("64m");  
   });});
```

