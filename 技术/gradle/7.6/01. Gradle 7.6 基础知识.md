---
author: zjmantou
title: Gradle 7.6
time: 2024-07-16 周二
tags:
  - 技术
  - Gradle
---
# 生命周期

- Initialization 初始化
- Configuration 配置
- Execution 执行

# 构建脚本

## Hello World

`build.gradle` 中编写 

```groovy
tasks.register("hello"){  
    doLast {  
        println("hello world")  
    }  
}
```

终端中输入`./gradlew -q hello` , （其中 -q 是抑制log输出，只输出error等级），测试时屏蔽掉其他日志，更清晰显示结果;

输出结果:

```shell
mantou@Mac-Office SentryDemo % ./gradlew -q hello
hello world
```

## 更多示例

```groovy
tasks.register('upper') {
    doLast {
        String someString = 'mY_nAmE'
        println "Original: $someString"
        println "Upper case: ${someString.toUpperCase()}"
    }
}

//输出
> gradle -q upper
Original: mY_nAmE
Upper case: MY_NAME
```

```groovy
tasks.register('count') {
    doLast {
        4.times { print "$it " }
    }
}

//输出
Output of gradle -q count  gradle -q count 的输出
> gradle -q count
0 1 2 3 
```


## 参考文档

[编写构建脚本](https://docs.gradle.org/7.6/userguide/tutorial_using_tasks.html)

# 使用buildSrc构建

复杂的构建逻辑通常适合封装为自定义任务或二进制插件。自定义任务和插件实现不应存在于构建脚本中。只要代码不需要在多个独立项目之间共享，使用 buildSrc 来实现此目的非常方便。 

目录 buildSrc 被视为包含的构建。发现该目录后，Gradle 会自动编译和测试此代码，并将其放入构建脚本的类路径中。对于多项目构建，只能有一个 buildSrc 目录，该目录必须位于根项目目录中。 buildSrc 应该优于脚本插件，因为它更容易维护、重构和测试代码。 

buildSrc 使用适用于 Java 和 Groovy 项目的相同源代码约定。它还提供对 Gradle API 的直接访问。可以在 buildSrc 下的专用 build.gradle 中声明其他依赖项。 

```groovy
##buildSrc/build.gradle

repositories {  
    mavenCentral()  
}  
  
dependencies {  
    testImplementation 'junit:junit:4.13'  
}
```

包含buildSrc的目录结构

```shell
├── buildSrc
│   ├── build.gradle
│   └── src
│       ├── main
│       │   └── java
│       │       └── com
│       │           └── enterprise
│       │               ├── Deploy.java
│       │               └── DeploymentPlugin.java
│       └── test
│           └── java
│               └── com
│                   └── enterprise
│                       └── DeploymentPluginTest.java
├── settings.gradle
├── subprojecto-one
│   └── build.gradle.kts
└── subproject-two
    └── build.gradle.kts
```

注意：
	`buildSrc` 中的更改会导致整个项目变得过时。因此，当进行小的增量更改时， --no-
	rebuild [命令行](https://docs.gradle.org/7.6/userguide/command_line_interface.html#sec:command_line_execution_options)
	选项通常有助于获得更快的反馈。不过，请记住定期运行完整的构建，或者至少在完
	成后运行。



# 属性
## Project 属性

| Name 姓名       | Type 类型                                                                                 | Default Value 默认值                                          |
| ------------- | --------------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| `project`     | [Project  项目](https://docs.gradle.org/7.6/dsl/org.gradle.api.Project.html)              | The `Project` instance  `Project` 实例                       |
| `name`        | `String`                                                                                | The name of the project directory.  <br>项目目录的名称。           |
| `path`        | `String`                                                                                | The absolute path of the project.  <br>项目的绝对路径。            |
| `description` | `String`                                                                                | A description for the project.  <br>项目的描述。                 |
| `projectDir`  | `File`                                                                                  | The directory containing the build script.  <br>包含构建脚本的目录。 |
| `buildDir`    | `File`                                                                                  | `_projectDir_/build`                                       |
| `group`       | `Object`                                                                                | `unspecified`                                              |
| `version`     | `Object`                                                                                | `unspecified`                                              |
| `ant`         | [AntBuilder  蚂蚁建造者](https://docs.gradle.org/7.6/javadoc/org/gradle/api/AntBuilder.html) | An `AntBuilder` instance 一个 `AntBuilder` 实例                |


## 局部属性与扩展属性

```groovy
//局部属性
def dest = 'dest'

tasks.register('copy', Copy) {
    from 'source'
    into dest
}

//扩展属性
ext {
    springVersion = "3.1.0.RELEASE"
    emailNotification = "build@master.org"
}
```

## 配置任意对象

```groovy
import java.text.FieldPosition

tasks.register('configure') {
    doLast {
        def pos = configure(new FieldPosition(10)) {
            beginIndex = 1
            endIndex = 5
        }
        println pos.beginIndex
        println pos.endIndex
    }
}
```


## 基础知识

- 属性访问器
- 方法调用时可选括号
- 列表和文字映射
- 闭包作为方法最后一个参数
- 关闭委托
- 默认导入的包

[构建脚本指引](https://docs.gradle.org/7.6/userguide/writing_build_scripts.html#sec:groovy_jdk)

# [Gradle 插件使用](https://docs.gradle.org/7.6/userguide/plugins.html)


## 作用

- 扩展 Gradle 模型（例如添加可配置的新 DSL 元素）
- 根据约定配置项目（例如添加新任务或配置合理的默认值）
- 应用特定配置（例如添加组织存储库或强制执行标准）

## 好处

- 促进重用并减少跨多个项目维护类似逻辑的开销
- 允许更高程度的模块化，增强可理解性和组织性
- 封装命令式逻辑并允许构建脚本尽可能具有声明性

## 类型

- 二进制插件：通过实现Plugin接口或使用DSL
- 脚本插件：附加的构建脚本

## 二进制插件
### 实现方式

- 使用插件 DSL 包含来自插件门户或自定义存储库的插件（请参阅使用插件 DSL 应用插件）。
- 包含来自定义为 buildscript 依赖项的外部 jar 的插件（请参阅使用 buildscript 块应用插件）。
- 将插件定义为项目中 buildSrc 目录下的源文件（请参阅使用 buildSrc 提取功能逻辑）。
- 将插件定义为构建脚本内的内联类声明。

### 使用插件 DSL 应用插件

```groovy
plugins {
    id 'java'
}

plugins {
    id 'com.jfrog.bintray' version '1.8.5'
}
```

### 将相同版本的外部插件应用到子项目

```Groovy
settings.gradle 
include 'hello-a'
include 'hello-b'
include 'goodbye-c'

build.gradle 
plugins {
    id 'com.example.hello' version '1.0.0' apply false
    id 'com.example.goodbye' version '1.0.0' apply false
}

hello-a/build.gradle
plugins {
    id 'com.example.hello'
}
hello-b/build.gradle
plugins {
    id 'com.example.hello'
}
goodbye-c/build.gradle
plugins {
    id 'com.example.goodbye'
}

```

**root层通过apply false 告知Gradle不要将插件应用到此项目，`plugins{}` 默认立即应用插件**

### 从 buildSrc 目录应用插件

```Groovy

buildSrc/build.gradle
//将 buildSrc 中定义的插件实现类 - my.MyPlugin 绑定到 ID“my-plugin”
plugins {
    id 'java-gradle-plugin'
}

gradlePlugin {
    plugins {
        myPlugins {
            id = 'my-plugin'
            implementationClass = 'my.MyPlugin'
        }
    }
}

build.gradle 
//其他项目中从buildSrc应用该插件
plugins {
    id 'my-plugin'
}

```


### 插件版本管理

`pluginManagement {}` 块只能出现在 `settings.gradle` 文件中（它必须是文件中的第一个块）或初始化脚本中. 

```groovy
settings.gradle 
pluginManagement {
    repositories {
        maven {
            url './maven-repo'
        }
        gradlePluginPortal()
        ivy {
            url './ivy-repo'
        }
    }
}
```


## 脚本插件

```groovy
apply from: 'other.gradle'
```

# [文件操作](https://docs.gradle.org/7.6/userguide/working_with_files.html)

- 复制单个文件
- 复制多个文件
- 复制目录层次结构
- 创建压缩档案（zip、tar等）
- 解压
- 创建“uber”或“fat”JAR
- 创建目录
- 移动文件和目录
- 重命名副本上的文件
- 删除文件和目录
- 深度文件路径
	- 在硬编码文件路径上
	- 单个文件和目录
	- 文件集合FileCollection
	- 文件树FileTree
	- 使用档案（zip、tar）作为文件树
	- 文件集合隐式转换
- 文件深度复制
	- 过滤文件
	- 重命名文件
	- 过滤文件内容（令牌替换、模板化等）
	- 使用 CopySpec 类
	- 使用子规范
	- 在您自己的任务中复制文件
	- 使用 Sync 任务镜像目录和文件集合
	- 将单个文件部署到应用程序服务器中
	- 安装可执行文件
- 深入档案创建
	- 档案命名
	- 在多个档案之间共享内容
	- 可重复的构建

# [日志](https://docs.gradle.org/7.6/userguide/logging.html)

```groovy
logger.quiet('An info log message which is always logged.')
logger.error('An error log message.')
logger.warn('A warning log message.')
logger.lifecycle('A lifecycle info log message.')
logger.info('An info log message.')
logger.debug('A debug log message.')
logger.trace('A trace log message.') // Gradle never logs TRACE level logs
```

## 日志级别

|   |   |
|---|---|
|ERROR|Error messages 错误信息|
|QUIET|Important information messages  <br>重要信息消息|
|WARNING|Warning messages 警告信息|
|LIFECYCLE|Progress information messages  <br>进度信息消息|
|INFO|Information messages 信息消息|
|DEBUG|Debug messages 调试消息|

## 选择日志级别

| Option 选项          | Outputs Log Levels 输出日志级别                      |
| ------------------ | ---------------------------------------------- |
| no logging options | LIFECYCLE and higher                           |
| `-q` or `--quiet`  | QUIET and higher                               |
| `-w` or `--warn`   | WARN and higher                                |
| `-i` or `--info`   | INFO and higher                                |
| `-d` or `--debug`  | DEBUG and higher (that is, all log messages)   |

### 堆栈跟踪命令行选项

- -s or --stacktrace：打印截断的堆栈跟踪
- -S or --full-stacktrace ：打印完整的堆栈日志
- `<No stacktrace options>`：不会将堆栈跟踪打印到控制台，仅在出现内部异常的情况下才会打印堆栈跟踪。如果选择 DEBUG 日志级别，则始终打印截断的堆栈跟踪。


# [避免陷阱](https://docs.gradle.org/7.6/userguide/potential_traps.html)

- 使用类型修饰符声明的变量在闭包中可见，但在方法中不可见。
- 注意生命周期
